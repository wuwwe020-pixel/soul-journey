<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¿ƒçµä¹‹æ—…</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --bg: #0d0f0e; --bg2: #141714; --bg3: #1a1f1b;
  --border: #2a312b; --text: #e8e4d8; --text2: #8a9088; --text3: #5a6058;
  --green: #4a8c5c; --green-bright: #6db882; --amber: #c9913a; --red: #c45a3a;
  --card-bg: #161a17;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans SC',sans-serif;font-weight:300;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");opacity:0.6}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* QUIZ OVERLAY */
.quiz-overlay{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px;animation:fadeIn 0.4s ease}
.quiz-overlay.hidden{display:none}
.quiz-box{width:100%;max-width:560px}
.quiz-logo{font-family:'Noto Serif SC',serif;font-size:28px;font-weight:700;color:var(--green-bright);margin-bottom:6px}
.quiz-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--amber);letter-spacing:3px;text-transform:uppercase;margin-bottom:40px}
.quiz-progress{display:flex;gap:4px;margin-bottom:40px}
.progress-dot{flex:1;height:2px;background:var(--border);border-radius:1px;transition:background 0.3s}
.progress-dot.done{background:var(--green)}
.progress-dot.active{background:var(--green-bright)}
.quiz-question{animation:fadeUp 0.35s ease}
.q-num{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;margin-bottom:12px}
.q-text{font-family:'Noto Serif SC',serif;font-size:22px;line-height:1.5;font-weight:400;margin-bottom:32px}
.q-options{display:flex;flex-direction:column;gap:10px}
.q-option{padding:16px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:14px;line-height:1.5;color:var(--text2);transition:all 0.2s;text-align:left}
.q-option:hover{border-color:var(--green);color:var(--text);background:var(--bg3)}
.q-option.selected{border-color:var(--green-bright);color:var(--green-bright);background:rgba(74,140,92,0.08)}
.quiz-result{display:none;animation:fadeUp 0.4s ease}
.result-label{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:16px}
.result-title{font-family:'Noto Serif SC',serif;font-size:36px;font-weight:700;color:var(--green-bright);margin-bottom:12px;line-height:1.2}
.result-soul{font-family:'Noto Serif SC',serif;font-size:16px;font-style:italic;color:var(--text2);margin-bottom:28px;line-height:1.6;padding-left:16px;border-left:2px solid var(--amber)}
.result-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:32px}
.result-tag{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1px;padding:5px 12px;border-radius:2px;text-transform:uppercase;background:rgba(74,140,92,0.12);color:var(--green-bright);border:1px solid rgba(74,140,92,0.3)}
.start-btn{width:100%;padding:16px;background:var(--green);border:none;border-radius:4px;color:white;font-family:'Space Mono',monospace;font-size:12px;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:background 0.2s}
.start-btn:hover{background:#3a7a4c}
.retake-btn{width:100%;margin-top:10px;padding:12px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text3);font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.retake-btn:hover{border-color:var(--text2);color:var(--text2)}

/* SLIDER QUESTION */
.q-slider-wrap{display:flex;flex-direction:column;gap:16px}
.q-slider-labels{display:flex;justify-content:space-between;gap:16px}
.q-slider-label-left,.q-slider-label-right{font-size:12px;color:var(--text2);line-height:1.5;max-width:45%}
.q-slider-label-right{text-align:right}
.q-slider{-webkit-appearance:none;width:100%;height:3px;border-radius:2px;background:linear-gradient(to right,var(--green-bright) 50%,var(--border) 50%);outline:none;cursor:pointer;transition:background 0.1s}
.q-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--green-bright);border:2px solid var(--bg);box-shadow:0 0 8px rgba(109,184,130,0.5);cursor:pointer}
.q-slider-value{text-align:center;font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);letter-spacing:2px}
.q-slider-confirm{width:100%;padding:14px;background:var(--green);border:none;border-radius:4px;color:white;font-family:'Space Mono',monospace;font-size:11px;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:background 0.2s}
.q-slider-confirm:hover{background:#3a7a4c}
.q-back-btn{width:100%;margin-top:8px;padding:10px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text3);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s}
.q-back-btn:hover{border-color:var(--text2);color:var(--text2)}

/* HEADER */
header{padding:18px 32px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100;background:rgba(13,15,14,0.94);backdrop-filter:blur(12px)}
.logo{font-family:'Noto Serif SC',serif;font-size:20px;font-weight:700;color:var(--green-bright)}
.logo-sub{font-family:'Space Mono',monospace;font-size:9px;color:var(--amber);letter-spacing:3px;text-transform:uppercase}
.persona-chip{margin-left:16px;padding:5px 12px;background:rgba(74,140,92,0.1);border:1px solid rgba(74,140,92,0.3);border-radius:20px;font-family:'Space Mono',monospace;font-size:10px;color:var(--green-bright);letter-spacing:1px;cursor:pointer;transition:all 0.2s;display:none}
.persona-chip:hover{background:rgba(74,140,92,0.2)}
.header-right{margin-left:auto;display:flex;gap:8px}
.nav-btn{padding:7px 16px;background:none;border:1px solid var(--border);border-radius:2px;color:var(--text2);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;position:relative}
.nav-btn:hover,.nav-btn.active{border-color:var(--green);color:var(--green-bright)}
.badge{position:absolute;top:-6px;right:-6px;background:var(--amber);color:#000;font-size:9px;font-weight:700;width:16px;height:16px;border-radius:50%;display:none;align-items:center;justify-content:center}
.badge.show{display:flex}

/* LAYOUT */
.app-layout{display:grid;grid-template-columns:380px 1fr;min-height:calc(100vh - 57px)}
.sidebar{border-right:1px solid var(--border);overflow-y:auto;background:var(--bg2)}
.sidebar::-webkit-scrollbar{width:3px}
.sidebar::-webkit-scrollbar-thumb{background:var(--border)}

/* MOBILE */
@media(max-width:768px){
  header{padding:14px 16px}
  .logo{font-size:16px}
  .logo-sub{display:none}
  .persona-chip{margin-left:8px;font-size:9px;padding:4px 8px}
  .nav-btn{padding:6px 10px;font-size:9px;letter-spacing:1px}
  .app-layout{grid-template-columns:1fr}
  .sidebar{border-right:none;border-bottom:1px solid var(--border);overflow-y:visible}
  .main-content{min-height:0}
  #map{min-height:220px;max-height:260px}
  .detail-panel{max-height:none;overflow-y:visible}
  .detail-inner{padding:20px 16px}
  .detail-title{font-size:20px}
  .transport-grid{grid-template-columns:1fr}
  .time-slots{padding-left:20px}
  .search-panel{padding:20px 16px}
  .q-text{font-size:18px}
  .result-title{font-size:28px}
  .saved-page{padding:20px 16px}
  .saved-grid{grid-template-columns:1fr}
}

/* SEARCH */
.search-panel{padding:28px 24px;border-bottom:1px solid var(--border)}
.panel-tag{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--amber);margin-bottom:16px}
.panel-title{font-family:'Noto Serif SC',serif;font-size:22px;line-height:1.4;margin-bottom:20px}
.panel-title em{font-style:italic;color:var(--green-bright)}
.field{margin-bottom:14px}
.field label{display:block;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:6px}
.field input,.field select{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Noto Sans SC',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;appearance:none}
.field input::placeholder{color:var(--text3)}
.field input:focus,.field select:focus{border-color:var(--green)}
.field select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 5 5-5' stroke='%235a6058' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;cursor:pointer}
.fields-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.search-btn{width:100%;margin-top:8px;padding:13px;background:var(--green);border:none;border-radius:3px;color:#fff;font-family:'Space Mono',monospace;font-size:11px;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:background 0.2s}
.search-btn:hover{background:#3a7a4c}
.search-btn:disabled{background:var(--text3);cursor:not-allowed}
.error-msg{margin-top:10px;font-size:12px;color:var(--red);font-family:'Space Mono',monospace}

/* RESULTS */
.results-list{padding:8px 0}
.state-box{padding:48px 24px;text-align:center;color:var(--text3)}
.state-icon{font-size:36px;margin-bottom:12px;opacity:0.4}
.state-title{font-family:'Noto Serif SC',serif;font-size:16px;font-style:italic;margin-bottom:6px;color:var(--text2)}
.state-sub{font-size:12px;line-height:1.6}
.result-card{padding:20px 24px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s}
.result-card:hover{background:var(--bg3)}
.result-card.active{background:var(--bg3);border-left:2px solid var(--green-bright);padding-left:22px}
.rc-num{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:8px}
.rc-title{font-family:'Noto Serif SC',serif;font-size:17px;font-weight:700;margin-bottom:4px}
.rc-loc{font-family:'Space Mono',monospace;font-size:10px;color:var(--amber);letter-spacing:1px;margin-bottom:8px}
.rc-why{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.rc-tags{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.tag{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;padding:3px 8px;border-radius:2px;text-transform:uppercase}
.tag-type{background:rgba(74,140,92,0.12);color:var(--green-bright);border:1px solid rgba(74,140,92,0.25)}
.tag-season{background:rgba(201,145,58,0.1);color:var(--amber);border:1px solid rgba(201,145,58,0.2)}
.tag-crowd{background:rgba(196,90,58,0.08);color:#e07a5a;border:1px solid rgba(196,90,58,0.18)}
.tag-match{background:rgba(109,184,130,0.1);color:#9dd4b0;border:1px solid rgba(109,184,130,0.2)}
.rc-footer{display:flex;align-items:center;justify-content:space-between}
.rc-days{font-family:'Space Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px}
.save-btn{background:none;border:1px solid var(--border);border-radius:2px;color:var(--text3);font-size:14px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
.save-btn:hover,.save-btn.saved{border-color:var(--amber);color:var(--amber)}

/* MAIN */
.main-content{display:flex;flex-direction:column;overflow:hidden}
#map{flex:1;min-height:300px;background:#0a0c0b;position:relative}
.map-hint{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--text3);pointer-events:none;z-index:1}
.map-hint p{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;opacity:0.4}

/* DETAIL */
.detail-panel{border-top:1px solid var(--border);background:var(--card-bg);overflow-y:auto;max-height:50vh;flex-shrink:0}
.detail-panel::-webkit-scrollbar{width:3px}
.detail-panel::-webkit-scrollbar-thumb{background:var(--border)}
.detail-empty{padding:32px;text-align:center;color:var(--text3);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase}
.detail-inner{padding:32px 40px;animation:fadeUp 0.3s ease}
.detail-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;gap:16px}
.detail-title{font-family:'Noto Serif SC',serif;font-size:26px;font-weight:700;line-height:1.2}
.detail-loc{font-family:'Space Mono',monospace;font-size:11px;color:var(--amber);letter-spacing:1.5px;margin-bottom:6px}
.detail-why{font-size:13px;color:var(--green-bright);margin-bottom:16px;font-style:italic}
.detail-save-btn{flex-shrink:0;padding:9px 18px;background:none;border:1px solid var(--border);border-radius:3px;color:var(--text2);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.detail-save-btn:hover,.detail-save-btn.saved{border-color:var(--amber);color:var(--amber)}
.detail-tags{display:flex;gap:8px;margin-bottom:28px;flex-wrap:wrap}
.section{margin-bottom:28px}
.section-label{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--green-bright);margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.day-block{margin-bottom:20px}
.day-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.day-num{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--amber);text-transform:uppercase;width:40px;flex-shrink:0}
.day-title-text{font-family:'Noto Serif SC',serif;font-size:15px;font-weight:700}
.time-slots{display:flex;flex-direction:column;gap:8px;padding-left:50px}
.time-slot{display:flex;gap:12px}
.time-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;width:32px;flex-shrink:0;padding-top:2px}
.time-content{font-size:13px;color:var(--text2);line-height:1.6}
.transport-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.transport-item{background:var(--bg3);border:1px solid var(--border);padding:14px 16px;border-radius:3px}
.transport-type{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--amber);margin-bottom:6px}
.transport-desc{font-size:13px;color:var(--text2);line-height:1.5}
.stay-box{background:var(--bg3);border:1px solid var(--border);padding:16px 20px;border-radius:3px}
.stay-type{font-family:'Noto Serif SC',serif;font-size:15px;font-weight:700;margin-bottom:4px}
.stay-price{font-family:'Space Mono',monospace;font-size:10px;color:var(--amber);letter-spacing:1px;margin-bottom:8px}
.stay-reason{font-size:13px;color:var(--text2);line-height:1.5}
.food-list{display:flex;flex-wrap:wrap;gap:8px}
.food-item{padding:8px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--text2)}

/* SAVED PAGE */
.saved-page{display:none;padding:40px;overflow-y:auto;min-height:calc(100vh - 57px)}
.saved-page.visible{display:block}
.page-title{font-family:'Noto Serif SC',serif;font-size:26px;font-weight:400;margin-bottom:4px}
.page-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:32px}
.saved-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:2px}
.saved-card{background:var(--card-bg);border:1px solid var(--border);padding:24px;transition:border-color 0.2s}
.saved-card:hover{border-color:var(--green)}
.sc-title{font-family:'Noto Serif SC',serif;font-size:18px;font-weight:700;margin-bottom:4px}
.sc-loc{font-family:'Space Mono',monospace;font-size:10px;color:var(--amber);letter-spacing:1px;margin-bottom:10px}
.sc-why{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:14px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.sc-footer{display:flex;align-items:center;justify-content:space-between}
.sc-days{font-family:'Space Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase}
.sc-remove{background:none;border:1px solid var(--border);border-radius:2px;color:var(--text3);font-size:11px;padding:5px 10px;cursor:pointer;font-family:'Space Mono',monospace;transition:all 0.2s}
.sc-remove:hover{border-color:var(--red);color:var(--red)}
.saved-empty{text-align:center;padding:80px 40px;color:var(--text3)}
</style>
</head>
<body>

<!-- QUIZ OVERLAY -->
<div class="quiz-overlay" id="quiz-overlay">
  <div class="quiz-box">
    <div class="quiz-logo">å¿ƒçµä¹‹æ—…</div>
    <div class="quiz-sub">/ Soul Journey Â· æ‰¾åˆ°çœŸæ­£å±äºä½ çš„æ—…è¡Œæ–¹å¼</div>
    <div class="quiz-progress" id="quiz-progress"></div>
    <div class="quiz-question" id="quiz-question"></div>
    <div class="quiz-result" id="quiz-result">
      <div class="result-label">ä½ çš„æ—…è¡Œäººæ ¼</div>
      <div class="result-title" id="result-title"></div>
      <div class="result-soul" id="result-soul"></div>
      <div class="result-tags" id="result-tags"></div>
      <button class="start-btn" onclick="enterApp()">å¼€å§‹è§„åˆ’æˆ‘çš„æ—…ç¨‹ â†’</button>
      <button class="retake-btn" onclick="startQuiz()">é‡æ–°æµ‹è¯•</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div>
    <div class="logo">å¿ƒçµä¹‹æ—…</div>
    <div class="logo-sub">Soul Journey</div>
  </div>
  <div class="persona-chip" id="persona-chip" onclick="showQuiz()"></div>
  <div class="header-right">
    <button class="nav-btn active" id="btn-explore" onclick="showPage('explore')">æ¢ç´¢</button>
    <button class="nav-btn" id="btn-saved" onclick="showPage('saved')">æ”¶è—<span class="badge" id="saved-badge">0</span></button>
  </div>
</header>

<!-- EXPLORE PAGE -->
<div id="page-explore">
  <div class="app-layout">
    <aside class="sidebar">
      <div class="search-panel">
        <div class="panel-tag">/ ä¸ºä½ å®šåˆ¶çš„æ—…è¡Œæ–¹æ¡ˆ</div>
        <div class="panel-title">å»<em>å±äºä½ </em>çš„<br>é‚£ç‰‡é£æ™¯</div>
        <div class="field">
          <label>ç›®æ ‡åŸå¸‚æˆ–åœ°åŒº</label>
          <input type="text" id="inp-region" placeholder="å¦‚ï¼šäº‘å—ã€ç”˜å—ã€çš–å—"/>
        </div>
        <div class="fields-row">
          <div class="field">
            <label>å‡ºè¡Œå¤©æ•°</label>
            <select id="inp-days">
              <option value="2">2 å¤©</option>
              <option value="3" selected>3 å¤©</option>
              <option value="5">5 å¤©</option>
              <option value="7">7 å¤©</option>
              <option value="10">10 å¤©</option>
              <option value="14">14 å¤©</option>
            </select>
          </div>
          <div class="field">
            <label>å‡ºå‘æ—¶é—´</label>
            <select id="inp-time">
              <option value="è¿‘æœŸ">è¿‘æœŸå‡ºå‘</option>
              <option value="æ˜¥å­£">æ˜¥å­£ï¼ˆ3-5æœˆï¼‰</option>
              <option value="å¤å­£">å¤å­£ï¼ˆ6-8æœˆï¼‰</option>
              <option value="ç§‹å­£">ç§‹å­£ï¼ˆ9-11æœˆï¼‰</option>
              <option value="å†¬å­£">å†¬å­£ï¼ˆ12-2æœˆï¼‰</option>
            </select>
          </div>
        </div>
        <button class="search-btn" id="search-btn" onclick="doSearch()">
          <span id="btn-text">ä¸ºæˆ‘å®šåˆ¶è¡Œç¨‹</span>
        </button>
        <div class="error-msg" id="error-msg"></div>
      </div>
      <div class="results-list" id="results-list">
        <div class="state-box">
          <div class="state-icon">âœ¦</div>
          <div class="state-title">ç­‰å¾…ä½ çš„ç¬¬ä¸€æ¬¡æ¢ç´¢</div>
          <div class="state-sub">å®Œæˆæµ‹è¯•åè¾“å…¥ç›®æ ‡åœ°åŒº<br>è·å–ä¸“å±äºä½ çš„æ—…è¡Œæ–¹æ¡ˆ</div>
        </div>
      </div>
    </aside>
    <main class="main-content">
      <div id="map">
        <div class="map-hint" id="map-hint">
          <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
            <path d="M24 4C15.16 4 8 11.16 8 20C8 32 24 44 24 44C24 44 40 32 40 20C40 11.16 32.84 4 24 4Z" stroke="#4a8c5c" stroke-width="1.5" fill="none" opacity="0.5"/>
            <circle cx="24" cy="20" r="5" stroke="#4a8c5c" stroke-width="1.5" fill="none" opacity="0.5"/>
          </svg>
          <p>é€‰æ‹©æ–¹æ¡ˆåæ˜¾ç¤ºè·¯çº¿åœ°å›¾</p>
        </div>
      </div>
      <div class="detail-panel" id="detail-panel">
        <div class="detail-empty" id="detail-empty">â† ç‚¹å‡»å·¦ä¾§æ–¹æ¡ˆæŸ¥çœ‹è¯¦ç»†è¡Œç¨‹</div>
        <div class="detail-inner" id="detail-inner" style="display:none"></div>
      </div>
    </main>
  </div>
</div>

<!-- SAVED PAGE -->
<div id="page-saved" class="saved-page">
  <div class="page-title">æˆ‘çš„æ”¶è—</div>
  <div class="page-sub">/ Saved Journeys</div>
  <div id="saved-content"></div>
</div>

<script>
// type: 'choice' | 'slider'
// slider: {key, min, max, minLabel, minScore, maxLabel, maxScore}
const QUESTIONS = [
  { text:'æ—…è¡Œä¸­ç‹¬è‡ªå¾…ç€ä¸€æ•´å¤©ï¼Œä½ ä¼š...', options:[
    {text:'éå¸¸å……å®ï¼Œè¿™æ­£æ˜¯æˆ‘éœ€è¦çš„',scores:{I:3,lone:2}},
    {text:'è¿˜å¥½ï¼Œå¶å°”æœ‰äººè¯´ä¸¤å¥æ›´è‡ªåœ¨',scores:{I:1,E:1,lone:1}},
    {text:'æœ‰ç‚¹éš¾å—ï¼Œæ›´å–œæ¬¢æœ‰äººä¸€èµ·',scores:{E:2,lone:0}},
    {text:'å®Œå…¨æ²¡é—®é¢˜ï¼Œç‹¬å¤„æ˜¯ä¸€ç§äº«å—',scores:{I:3,lone:3}}
  ]},
  { text:'ç†æƒ³çš„æ—…è¡ŒèŠ‚å¥æ˜¯...', options:[
    {text:'ä¹°å¥½ç¥¨å†æƒ³å»å“ªï¼Œèµ°åˆ°å“ªç®—å“ª',scores:{free:3}},
    {text:'å¤§æ–¹å‘å®šå¥½ï¼Œæ¯å¤©éšç¼˜',scores:{free:2,plan:1}},
    {text:'ä¸»è¦æ™¯ç‚¹æå‰æŸ¥å¥½ï¼Œç»†èŠ‚å¼¹æ€§',scores:{free:1,plan:2}},
    {text:'è¡Œç¨‹å®‰æ’æ»¡ï¼Œæ¯å¤©éƒ½æœ‰è®¡åˆ’',scores:{plan:3}}
  ]},
  { text:'æ›´èƒ½æ‰“åŠ¨ä½ çš„é£æ™¯æ˜¯...', options:[
    {text:'æ— äººçš„æ—·é‡ã€æ˜Ÿç©ºã€å±±é—´äº‘é›¾',scores:{nature:3}},
    {text:'å¤è€çš„è¡—å··ã€æ–‘é©³çš„å¢™å£ã€æ–¹è¨€',scores:{culture:3}},
    {text:'æµ·è¾¹æ¸”æ‘çš„çƒŸç«æ°”å’Œæ½®æ¹¿çš„é£',scores:{nature:1,culture:1,vibe:2}},
    {text:'ä¸¤ç§éƒ½è¡Œï¼Œéšå¿ƒæƒ…å†³å®š',scores:{nature:1,culture:1}}
  ]},
  { text:'è®¡åˆ’ä¸´æ—¶è¢«æ‰“ä¹±æ—¶ï¼Œä½ çš„ç¬¬ä¸€ååº”æ˜¯...', options:[
    {text:'æœ‰ç‚¹å°æ…Œï¼Œä½†å¾ˆå¿«è°ƒæ•´è¿‡æ¥',scores:{adapt:2}},
    {text:'å®Œå…¨æ²¡å…³ç³»ï¼Œæ„å¤–å¾€å¾€æ›´æœ‰æ„æ€',scores:{adapt:3,free:1}},
    {text:'æœ‰äº›ä¸èˆ’æœï¼Œéœ€è¦æ—¶é—´æ¥å—',scores:{adapt:1,plan:1}},
    {text:'ä¼šæ˜æ˜¾ç„¦è™‘ï¼Œä¸ç¡®å®šæ„Ÿè®©æˆ‘éš¾å—',scores:{plan:2,adapt:0}}
  ]},
  { text:'ä½å®¿æ–¹é¢ï¼Œä½ çš„åº•çº¿æ˜¯...', options:[
    {text:'å¸ç¯·ã€åœ°é“ºã€å†œå®¶åœŸç‚•éƒ½æ— æ‰€è°“',scores:{rough:3}},
    {text:'æœ‰åºŠæœ‰å±‹é¡¶ï¼Œå¹²ä¸å¹²å‡€æ— æ‰€è°“',scores:{rough:2,comfort:1}},
    {text:'éœ€è¦ç‹¬ç«‹å«æµ´ï¼Œä½†ä¸æŒ‘æ¡£æ¬¡',scores:{comfort:2}},
    {text:'å¹²å‡€æ•´æ´æ˜¯åŸºæœ¬ï¼Œæœ€å¥½æœ‰çƒ­æ°´æµ´ç¼¸',scores:{comfort:3,spend:1}}
  ]},
  { text:'æ—…é€”ä¸­ä½ ä¼šä¸»åŠ¨æ‹ç…§æˆ–è®°å½•å—...', options:[
    {text:'éšæ‰‹æ‹ï¼Œä½†ä¸æ‰§ç€ï¼Œæ„Ÿå—æ¯”è®°å½•é‡è¦',scores:{record:1}},
    {text:'ä¼šè®¤çœŸæ‹ï¼Œæƒ³ç•™ä½é‚£äº›ç¬é—´',scores:{record:2,visual:1}},
    {text:'åŸºæœ¬ä¸æ‹ï¼Œç”¨çœ¼ç›å’Œå¿ƒæ„Ÿå—å°±å¤Ÿäº†',scores:{record:0,calm:1}},
    {text:'ä¼šå†™æ—¥è®°æˆ–æ–‡å­—ï¼Œç…§ç‰‡ä¹Ÿæ‹',scores:{record:3,vibe:1}}
  ]},
  { text:'é‡åˆ°ä¸ç†Ÿæ‚‰çš„é£Ÿç‰©ï¼Œä½ ä¼š...', options:[
    {text:'å¿…é¡»å°ï¼è¿™å°±æ˜¯æ—…è¡Œçš„æ„ä¹‰',scores:{food:3}},
    {text:'å…ˆè§‚å¯Ÿä¸€ä¸‹ï¼Œçœ‹èµ·æ¥å¥½å°±è¯•è¯•',scores:{food:2}},
    {text:'å¦‚æœå½“åœ°äººæ¨èå°±è¯•ï¼Œå¦åˆ™ç®—äº†',scores:{food:1}},
    {text:'ä¿å®ˆä¸€ç‚¹ï¼Œé€‰ç†Ÿæ‚‰çš„åƒ',scores:{food:0}}
  ]},
  { text:'å‡ºè¡Œæ–¹å¼ä½ æ›´åå¥½...', options:[
    {text:'è‡ªé©¾ï¼Œèµ°åˆ°å“ªåœåˆ°å“ª',scores:{drive:3}},
    {text:'å…¬å…±äº¤é€šä¸ºä¸»ï¼Œå¤§é‡æ­¥è¡Œ',scores:{walk:3}},
    {text:'åŒ…è½¦æˆ–æ‹¼è½¦ï¼Œçµæ´»ä½†ä¸ç”¨è‡ªå·±å¼€',scores:{drive:1,walk:1}},
    {text:'éª‘è¡Œæˆ–å¾’æ­¥ï¼Œç”¨èº«ä½“ä¸ˆé‡è·ç¦»',scores:{walk:2,thrill:1}}
  ]},
  { text:'æ—…è¡Œä¸­ä½ æ›´äº«å—çš„çŠ¶æ€æ˜¯...', options:[
    {text:'åœ¨æŸå¤„å‘å‘†ä¸¤å°æ—¶ï¼Œä»€ä¹ˆéƒ½ä¸åš',scores:{calm:3}},
    {text:'è¾¹èµ°è¾¹çœ‹ï¼Œä¸ç´§ä¸æ…¢',scores:{calm:2,thrill:1}},
    {text:'çˆ¬å±±æ¶‰æ°´ï¼Œæœ‰ä¸€å®šä½“åŠ›æŒ‘æˆ˜',scores:{thrill:2,calm:1}},
    {text:'æé™æŒ‘æˆ˜ï¼Œè¶Šéš¾è¶Šå¸¦åŠ²',scores:{thrill:3}}
  ]},
  { type:'slider', text:'ä½ ä¸é™Œç”Ÿäººçš„è·ç¦»æ„Ÿ...', key:'social',
    minLabel:'èƒ½èŠå°±èŠï¼Œæ—…é€”ä¸­çš„é™Œç”Ÿäººå¾€å¾€æ˜¯æƒŠå–œ', minScore:{E:3},
    maxLabel:'ä¿æŒè·ç¦»ï¼Œæ—…è¡Œæ˜¯æˆ‘å’Œè‡ªå·±çš„äº‹', maxScore:{I:3}
  },
  { type:'slider', text:'ä½ å¯¹æ—…è¡Œé¢„ç®—çš„æ€åº¦...', key:'budget_feel',
    minLabel:'èƒ½çœåˆ™çœï¼Œé’±çœä¸‹æ¥å¤šèµ°å‡ ä¸ªåœ°æ–¹', minScore:{budget:3},
    maxLabel:'è¯¥èŠ±å°±èŠ±ï¼Œæ—…è¡Œçš„è´¨æ„Ÿå¾ˆé‡è¦', maxScore:{spend:3}
  },
  { type:'slider', text:'æ—…è¡Œç»“æŸåï¼Œä½ é€šå¸¸æ„Ÿåˆ°...', key:'energy',
    minLabel:'ç²¾åŠ›å……æ²›ï¼Œå·²ç»åœ¨æƒ³ä¸‹ä¸€æ¬¡å»å“ªäº†', minScore:{E:2,thrill:1},
    maxLabel:'éœ€è¦å‡ å¤©æ‰èƒ½ç¼“è¿‡æ¥ï¼Œèº«å¿ƒéƒ½è¦å……ç”µ', minScore2:{I:2,calm:1}
  }
];

const PERSONAS = [
  {id:'hermit',name:'è’é‡éšå£«',soul:'åªæœ‰æ— äººçš„æ—·é‡æ‰èƒ½è®©æˆ‘çœŸæ­£å‘¼å¸ï¼ŒåŸå¸‚æ˜¯åˆ«äººçš„ï¼Œå±±é‡æ‰æ˜¯æˆ‘çš„ã€‚',tags:['ç‹¬å¤„','è‡ªç„¶','é™è°§'],match:s=>s.I>=3&&s.nature>=3&&s.calm>=2},
  {id:'meditator',name:'å±±é‡å†¥æƒ³è€…',soul:'ç”¨è„šä¸ˆé‡å±±å·ï¼Œç”¨æ²‰é»˜å¯¹è¯è‡ªç„¶ï¼Œæ—…è¡Œæ˜¯ä¸€ç§ä¿®è¡Œã€‚',tags:['å¾’æ­¥','å†…çœ','è‡ªç„¶'],match:s=>s.I>=2&&s.nature>=2&&s.walk>=1},
  {id:'cloud',name:'äº‘ç«¯æ¼«æ­¥è€…',soul:'è¿·æ‹é«˜å¤„çš„é£å’Œä½å¤„çœ‹ä¸è§çš„æ‘åº„ï¼Œå»æ²¡æœ‰ä¿¡å·çš„åœ°æ–¹å¾…å‡ å¤©ã€‚',tags:['é«˜åŸ','å­¤ç‹¬','äº‘é›¾'],match:s=>s.nature>=2&&s.thrill>=1&&s.I>=1},
  {id:'listener',name:'æ—é—´è†å¬è€…',soul:'èµ°è¿›æ ‘æ—ï¼Œæ‰å‘ç°åŸå¸‚æœ‰å¤šåµï¼Œæˆ‘éœ€è¦è¿™ç§å®‰é™ã€‚',tags:['æ£®æ—','ç‹¬å¤„','æ…¢è¡Œ'],match:s=>s.nature>=2&&s.calm>=2&&s.I>=2},
  {id:'lightchaser',name:'æ—·é‡è¿½å…‰äºº',soul:'ä¸“é—¨å»æ‰¾é‚£äº›å…‰çº¿åˆšå¥½çš„ç¬é—´ï¼Œä¸ºäº†ä¸€ä¸ªæ—¥å‡ºå¯ä»¥çˆ¬ä¸‰ä¸ªå°æ—¶ã€‚',tags:['æ‘„å½±æ„Ÿ','æ™¨æ˜','æ—·é‡'],match:s=>s.nature>=2&&(s.vibe>=1||s.visual>=1)&&s.record>=1},
  {id:'archaeologist',name:'æ—¶å…‰è€ƒå¤è€…',soul:'æ¯ä¸€å—æ—§ç –éƒ½è—ç€æˆ‘æƒ³å¬çš„æ•…äº‹ï¼Œå†å²æ˜¯æ—…è¡Œæœ€å¥½çš„å‘å¯¼ã€‚',tags:['å¤è¿¹','äººæ–‡','å†å²'],match:s=>s.culture>=3&&s.vibe>=1},
  {id:'alley',name:'è¡—å··æ¼«æ¸¸è€…',soul:'ä¸å»æ™¯ç‚¹ï¼Œåªåœ¨å°å··é‡Œèµ°ä¸¢ï¼Œæœ€å¥½è¿·è·¯ä¸‰æ¬¡ã€‚',tags:['å¤é•‡','éšæ€§','äººæ–‡'],match:s=>s.culture>=2&&s.free>=2},
  {id:'observer',name:'äººé—´è§‚å¯Ÿå‘˜',soul:'ååœ¨å¸‚é›†è§’è½ï¼Œçœ‹äººæ¯”çœ‹é£æ™¯æ›´æœ‰æ„æ€ï¼Œç”Ÿæ´»æœ¬èº«å°±æ˜¯é£æ™¯ã€‚',tags:['å¸‚äº•','äººæ–‡','å†…å‘'],match:s=>s.culture>=2&&s.I>=2&&s.calm>=1},
  {id:'frontier',name:'è¾¹åœ°å¯»è®¿è€…',soul:'è¿·æ‹é‚£äº›è¢«é—å¿˜çš„è¾¹å¢ƒå°é•‡ä¸æ¶ˆå¤±çš„æ–¹è¨€ï¼Œå»æ—¶é—´é—å¿˜çš„åœ°æ–¹ã€‚',tags:['è¾¹å¢ƒ','å†·é—¨','äººæ–‡'],match:s=>s.culture>=2&&s.nature>=1&&s.rough>=1},
  {id:'explorer',name:'å±±é‡æ¢é™©å®¶',soul:'æ²¡æœ‰ä¸€ç‚¹éš¾åº¦çš„è·¯ï¼Œèµ°èµ·æ¥æ²¡æ„æ€ã€‚è¶Šéš¾èµ°çš„åœ°æ–¹ï¼Œè¶Šå€¼å¾—ã€‚',tags:['å¾’æ­¥','æŒ‘æˆ˜','å†’é™©'],match:s=>s.thrill>=3&&s.nature>=2},
  {id:'ascetic',name:'æç®€è‹¦è¡Œè€…',soul:'è¶Šéš¾èµ°çš„åœ°æ–¹ï¼Œé£æ™¯è¶Šä¸ä¼šéª—äººï¼Œèº«ä½“çš„è‹¦æ¢å¿ƒçµçš„é™ã€‚',tags:['è‹¦è¡Œ','æç®€','æŒ‘æˆ˜'],match:s=>s.thrill>=2&&s.budget>=2&&s.rough>=2},
  {id:'sensation',name:'æ„Ÿå®˜çŒäºº',soul:'è¦å†·åˆ°é¢¤æŠ–ï¼Œè¦çƒ­åˆ°å‡ºæ±—ï¼Œæ—…è¡Œè¦æœ‰ä½“æ„Ÿï¼Œè¦è®©èº«ä½“è®°ä½ã€‚',tags:['æç«¯ä½“éªŒ','æ„Ÿå®˜','å†’é™©'],match:s=>s.thrill>=2&&s.visual>=1},
  {id:'pathless',name:'å­¤å‹‡ç©¿è¶Šè€…',soul:'åœ°å›¾ä¸Šæ²¡æœ‰è·¯çš„åœ°æ–¹ï¼Œæ‰æ˜¯æˆ‘è¦å»çš„ï¼Œè§„åˆ™æ˜¯ä¸ºèƒ†å°è€…è®¾çš„ã€‚',tags:['ç©¿è¶Š','æ— äººåŒº','æé™'],match:s=>s.thrill>=3&&s.rough>=2&&s.free>=1},
  {id:'drifter',name:'éšæ€§æµªäºº',soul:'ä¹°äº†ç¥¨å†æƒ³å»å“ªï¼Œèµ°åˆ°å“ªç®—å“ªï¼Œè®¡åˆ’æ˜¯ç”¨æ¥æ‰“ç ´çš„ã€‚',tags:['éšæ€§','è‡ªç”±','æ¼‚æ³Š'],match:s=>s.free>=3&&s.E>=1},
  {id:'encounter',name:'å¶é‡æ”¶é›†è€…',soul:'æ—…é€”ä¸­æœ€å¥½çš„é£æ™¯æ˜¯æ„å¤–é‡è§çš„äººï¼Œæ¯æ¬¡å¶é‡éƒ½æ˜¯å‘½è¿ã€‚',tags:['ç¤¾äº¤','éšç¼˜','æ¸©æš–'],match:s=>s.E>=2&&s.free>=2},
  {id:'slow',name:'æ…¢è¡Œæ•£æ¼«å®¢',soul:'ä¸€ä¸ªåœ°æ–¹å¾…ä¸‰å¤©ï¼Œåªæ˜¯å‘å‘†å’Œåƒä¸œè¥¿ï¼Œè¿™æ‰å«æ—…è¡Œã€‚',tags:['æ…¢æ¸¸','å‘å‘†','æ²‰æµ¸'],match:s=>s.free>=1&&s.calm>=2&&s.plan<=1},
  {id:'unplanned',name:'æ— è®¡åˆ’ä¸»ä¹‰è€…',soul:'æ”»ç•¥æ˜¯åˆ«äººçš„ï¼Œæ„Ÿå—æ‰æ˜¯è‡ªå·±çš„ï¼Œèµ°è¿›å»å†è¯´ã€‚',tags:['éšæ€§','ç›´è§‰','å½“ä¸‹'],match:s=>s.free>=3&&s.plan<=1},
  {id:'solitary',name:'å­¤ç‹¬è¡Œè€…',soul:'ä¸€ä¸ªäººæ—…è¡Œï¼Œæ‰èƒ½çœŸæ­£å’Œè‡ªå·±è¯´ä¸Šè¯ï¼Œç‹¬å¤„æ˜¯ç¤¼ç‰©ã€‚',tags:['ç‹¬æ—…','å†…çœ','è‡ªç”±'],match:s=>s.I>=3&&s.free>=1},
  {id:'healer',name:'å¤±è”ç–—æ„ˆè€…',soul:'å‡ºå‘æ˜¯ä¸ºäº†æ–­å¼€ï¼Œä¸æ˜¯ä¸ºäº†æ‰“å¡ï¼Œéœ€è¦ä¸€æ¬¡å½»åº•çš„æ¶ˆå¤±ã€‚',tags:['ç–—æ„ˆ','é€ƒç¦»','é™å¿ƒ'],match:s=>s.I>=2&&s.calm>=2&&s.nature>=1},
  {id:'boundary',name:'è¾¹ç•Œæ¶ˆè§£è€…',soul:'åœ¨é™Œç”Ÿåœ°æ–¹ï¼Œæ‰æ„Ÿè§‰è‡ªå·±å¯ä»¥é‡æ–°å¼€å§‹ï¼Œæ—…è¡Œæ˜¯ä¸€ç§é‡ç”Ÿã€‚',tags:['èœ•å˜','é™Œç”Ÿæ„Ÿ','å†…çœ'],match:s=>s.I>=2&&s.vibe>=2},
  {id:'stillness',name:'é™è§‚æµæµªè€…',soul:'ä¸èµ¶è·¯ï¼Œä¸æ‹ç…§ï¼Œåªæ˜¯çœ‹ç€ï¼Œè®©æ—¶é—´æ…¢ä¸‹æ¥ã€‚',tags:['æç®€','å½“ä¸‹','å†¥æƒ³'],match:s=>s.calm>=3&&s.I>=1&&s.record<=1},
  {id:'glamper',name:'ç²¾è‡´é‡å¥¢å®¢',soul:'ç™½å¤©çˆ¬å±±ï¼Œæ™šä¸Šè¦æœ‰å¥½åºŠå’Œçƒ­æ°´ï¼Œäº«å—ä¸å¦¨ç¢é‡æ€§ã€‚',tags:['é‡å¥¢','èˆ’é€‚','è‡ªç„¶'],match:s=>s.nature>=1&&s.comfort>=2&&s.spend>=1},
  {id:'resident',name:'æ…¢åŸå®šå±…è€…',soul:'æ¯æ¬¡æ—…è¡Œéƒ½æƒ³è±¡è‡ªå·±ä½åœ¨é‚£é‡Œï¼Œæ—…è¡Œæ˜¯åœ¨é€‰æ‹©å¦ä¸€ç§ç”Ÿæ´»ã€‚',tags:['æ…¢åŸ','ç”Ÿæ´»æ„Ÿ','æ²‰æµ¸'],match:s=>s.calm>=1&&s.culture>=1&&s.comfort>=1&&s.plan>=1},
  {id:'foodie',name:'å¸‚äº•ç¾é£Ÿå®¶',soul:'è·Ÿç€å½“åœ°äººåƒï¼Œæ‰ç®—çœŸçš„åˆ°è¿‡é‚£é‡Œï¼Œèƒƒæ˜¯æœ€è¯šå®çš„æ—…è¡Œè®°å½•ã€‚',tags:['ç¾é£Ÿ','å¸‚äº•','åœ¨åœ°'],match:s=>s.food>=2&&s.culture>=1&&s.E>=1}
];

let answers=[],currentQ=0,scores={},persona=null,plans=[],savedPlans=JSON.parse(localStorage.getItem('sj_saved')||'[]'),activeId=null,map=null,markers=[],routeLine=null;

function startQuiz(){
  answers=[];currentQ=0;
  scores={I:0,E:0,free:0,plan:0,nature:0,culture:0,rough:0,comfort:0,drive:0,walk:0,calm:0,thrill:0,budget:0,spend:0,vibe:0,visual:0,lone:0,adapt:0,record:0,food:0,social:0,budget_feel:0,energy:0};
  document.getElementById('quiz-result').style.display='none';
  document.getElementById('quiz-question').style.display='block';
  renderQuiz();
}

function renderQuiz(){
  const q=QUESTIONS[currentQ];
  const prog=document.getElementById('quiz-progress');
  prog.innerHTML=QUESTIONS.map((_,i)=>`<div class="progress-dot ${i<currentQ?'done':i===currentQ?'active':''}"></div>`).join('');
  const qEl=document.getElementById('quiz-question');
  qEl.style.animation='none';qEl.offsetHeight;qEl.style.animation='fadeUp 0.35s ease';

  const backBtn=currentQ>0?`<button class="q-back-btn" onclick="goBack()">â† ä¸Šä¸€é¢˜</button>`:'';
  if(q.type==='slider'){
    qEl.innerHTML=`
      <div class="q-num">é—®é¢˜ ${currentQ+1} / ${QUESTIONS.length}</div>
      <div class="q-text">${q.text}</div>
      <div class="q-slider-wrap">
        <div class="q-slider-labels">
          <span class="q-slider-label-left">${q.minLabel}</span>
          <span class="q-slider-label-right">${q.maxLabel}</span>
        </div>
        <input type="range" class="q-slider" id="slider-input" min="0" max="100" value="50">
        <div class="q-slider-value" id="slider-val">ä¸­é—´</div>
        <button class="q-slider-confirm" onclick="confirmSlider()">ç¡®è®¤ â†’</button>
      </div>
      ${backBtn}`;
    const sl=document.getElementById('slider-input');
    const updateSlider=()=>{
      const v=parseInt(sl.value);
      sl.style.background=`linear-gradient(to right,var(--green-bright) ${v}%,var(--border) ${v}%)`;
      const el=document.getElementById('slider-val');
      if(v<=20)el.textContent='â† éå¸¸åå·¦';
      else if(v<=40)el.textContent='â† åå·¦';
      else if(v<=60)el.textContent='å±…ä¸­';
      else if(v<=80)el.textContent='åå³ â†’';
      else el.textContent='éå¸¸åå³ â†’';
    };
    sl.addEventListener('input',updateSlider);
    updateSlider();
  } else {
    qEl.innerHTML=`<div class="q-num">é—®é¢˜ ${currentQ+1} / ${QUESTIONS.length}</div><div class="q-text">${q.text}</div><div class="q-options">${q.options.map((o,i)=>`<button class="q-option" onclick="selectOption(${i})">${o.text}</button>`).join('')}</div>${backBtn}`;
  }
}

function goBack(){
  if(currentQ<=0)return;
  // æ’¤é”€ä¸Šä¸€é¢˜åˆ†æ•°
  const prevQ=QUESTIONS[currentQ-1];
  const prevAnswer=answers[answers.length-1];
  if(prevQ.type==='slider'){
    const ratio=prevAnswer/100;
    const leftScores=prevQ.minScore||{};
    const rightScores=prevQ.maxScore||prevQ.minScore2||{};
    const allKeys=new Set([...Object.keys(leftScores),...Object.keys(rightScores)]);
    allKeys.forEach(k=>{
      const lv=leftScores[k]||0;const rv=rightScores[k]||0;
      scores[k]=(scores[k]||0)-Math.round(lv*(1-ratio)+rv*ratio);
    });
  } else {
    const opt=prevQ.options[prevAnswer];
    Object.entries(opt.scores).forEach(([k,v])=>{scores[k]=(scores[k]||0)-v;});
  }
  answers.pop();
  currentQ--;
  renderQuiz();
}

function confirmSlider(){
  const q=QUESTIONS[currentQ];
  const v=parseInt(document.getElementById('slider-input').value);
  const ratio=v/100;
  // å·¦ç«¯åˆ†æ•° * (1-ratio) + å³ç«¯åˆ†æ•° * ratio
  const leftScores=q.minScore||{};
  const rightScores=q.maxScore||q.minScore2||{};
  const allKeys=new Set([...Object.keys(leftScores),...Object.keys(rightScores)]);
  allKeys.forEach(k=>{
    const lv=leftScores[k]||0;
    const rv=rightScores[k]||0;
    const val=Math.round(lv*(1-ratio)+rv*ratio);
    scores[k]=(scores[k]||0)+val;
  });
  answers.push(v);
  setTimeout(()=>{currentQ++;currentQ<QUESTIONS.length?renderQuiz():showResult();},300);
}

function selectOption(i){
  const opt=QUESTIONS[currentQ].options[i];
  document.querySelectorAll('.q-option').forEach((el,idx)=>{el.classList.toggle('selected',idx===i);el.disabled=true;});
  Object.entries(opt.scores).forEach(([k,v])=>{scores[k]=(scores[k]||0)+v;});
  answers.push(i);
  setTimeout(()=>{currentQ++;currentQ<QUESTIONS.length?renderQuiz():showResult();},400);
}

function showResult(){
  let best=null,bestScore=-1;
  PERSONAS.forEach(p=>{
    if(p.match(scores)){
      const ms=Object.values(scores).reduce((a,v)=>a+v,0);
      if(ms>bestScore){bestScore=ms;best=p;}
    }
  });
  if(!best) best=scores.nature>=scores.culture?(scores.I>=scores.E?PERSONAS[0]:PERSONAS[4]):PERSONAS[5];
  persona=best;
  localStorage.setItem('sj_persona',JSON.stringify({persona:best,scores}));
  document.getElementById('quiz-question').style.display='none';
  document.getElementById('quiz-progress').innerHTML=QUESTIONS.map(()=>`<div class="progress-dot done"></div>`).join('');
  document.getElementById('result-title').textContent=best.name;
  document.getElementById('result-soul').textContent=best.soul;
  document.getElementById('result-tags').innerHTML=best.tags.map(t=>`<span class="result-tag">${t}</span>`).join('');
  document.getElementById('quiz-result').style.display='block';
}

function showQuiz(){document.getElementById('quiz-overlay').classList.remove('hidden');startQuiz();}

function enterApp(){
  document.getElementById('quiz-overlay').classList.add('hidden');
  const chip=document.getElementById('persona-chip');
  if(persona){chip.textContent=`âœ¦ ${persona.name}`;chip.style.display='flex';}
}

async function doSearch(){
  const region=document.getElementById('inp-region').value.trim();
  const days=document.getElementById('inp-days').value;
  const time=document.getElementById('inp-time').value;
  const errEl=document.getElementById('error-msg');
  if(!region){errEl.textContent='è¯·å¡«å†™ç›®æ ‡åœ°åŒº';return;}
  if(!persona){errEl.textContent='è¯·å…ˆå®Œæˆæ€§æ ¼æµ‹è¯•';return;}
  errEl.textContent='';
  const btn=document.getElementById('search-btn');
  const btnText=document.getElementById('btn-text');
  btn.disabled=true;btnText.textContent='å®šåˆ¶ä¸­...';

  const systemPrompt=`ä½ æ˜¯ä¸€ä½æ·±åº¦æ—…è¡Œé¡¾é—®ï¼Œä¸“é—¨æ ¹æ®æ—…è¡Œè€…çš„æ€§æ ¼åå¥½å®šåˆ¶çœŸå®ã€å…·ä½“ã€æœ‰æ·±åº¦çš„æ—…è¡Œæ–¹æ¡ˆã€‚

ç”¨æˆ·çš„æ—…è¡Œäººæ ¼æ˜¯ã€Œ${persona.name}ã€â€”â€”${persona.soul}
æ€§æ ¼æ ‡ç­¾ï¼š${persona.tags.join('ã€')}

è¯·æ ¹æ®æ­¤äººæ ¼æ¨è5ä¸ªæ—…è¡Œæ–¹æ¡ˆï¼Œè¿”å›çº¯JSONæ ¼å¼ï¼š
{
  "plans": [
    {
      "id": "å”¯ä¸€id",
      "title": "è¯—æ„æ–¹æ¡ˆå",
      "location": "å…·ä½“åœ°ç‚¹",
      "region": "çœä»½",
      "lat": çº¬åº¦,
      "lng": ç»åº¦,
      "whyYou": "ä¸ºä»€ä¹ˆç‰¹åˆ«é€‚åˆã€Œ${persona.name}ã€ï¼Œç»“åˆäººæ ¼ä¸€å¥è¯è¯´æ˜",
      "matchScore": "85%",
      "type": "å±±é‡/å¤è¿¹/æ°´ä¹¡/æ²™æ¼ /è‰åŸ/æµ·å²¸/å³¡è°·/é«˜åŸ/è¾¹åœ°",
      "crowd": "æå°‘äºº/è¾ƒå°‘äºº/å¶æœ‰æ¸¸å®¢",
      "season": "æœ€ä½³å­£èŠ‚",
      "days": å¤©æ•°æ•°å­—,
      "itinerary": [
        {
          "day": 1,
          "title": "å½“å¤©ä¸»é¢˜",
          "morning": "ä¸Šåˆå…·ä½“å»å“ªåšä»€ä¹ˆè€—æ—¶å¤šä¹…ï¼Œ50å­—å†…",
          "afternoon": "ä¸‹åˆå…·ä½“å»å“ªåšä»€ä¹ˆè€—æ—¶å¤šä¹…ï¼Œ50å­—å†…",
          "evening": "å‚æ™šå…·ä½“å»å“ªåšä»€ä¹ˆè€—æ—¶å¤šä¹…ï¼Œ50å­—å†…"
        }
      ],
      "transport": {
        "arrival": "å¦‚ä½•æŠµè¾¾ï¼ˆäº¤é€šå·¥å…·+å¤§æ¦‚ä»·æ ¼ï¼‰",
        "local": "å½“åœ°å¦‚ä½•ç§»åŠ¨ï¼ˆå…·ä½“è¯´æ˜ï¼‰"
      },
      "stay": {
        "type": "ä½å®¿ç±»å‹",
        "price": "ä»·æ ¼åŒºé—´å¦‚80-150å…ƒ/æ™š",
        "reason": "ä¸ºä»€ä¹ˆç¬¦åˆä½ çš„é£æ ¼"
      },
      "food": ["ç‰¹è‰²é£Ÿç‰©1","ç‰¹è‰²é£Ÿç‰©2","ç‰¹è‰²é£Ÿç‰©3"],
      "waypoints": [
        {"name": "åœ°ç‚¹å","lat": çº¬åº¦,"lng": ç»åº¦,"day": 1,"note": "ä¸€å¥è¯è¯´æ˜"}
      ]
    }
  ]
}

è¦æ±‚ï¼šæ¨èçœŸå®å­˜åœ¨çš„åœ°æ–¹ï¼Œåæ ‡å‡†ç¡®ï¼Œè¡Œç¨‹å…·ä½“ä¸æ³›æ³›ï¼Œæ¯ä¸ªæ–¹æ¡ˆç±»å‹ä¸åŒï¼Œçªå‡ºä¸ç”¨æˆ·äººæ ¼çš„åŒ¹é…æ„Ÿã€‚åªè¿”å›JSONã€‚`;

  const userMsg=`ç›®æ ‡åœ°åŒºï¼š${region}\nå‡ºè¡Œå¤©æ•°ï¼š${days}å¤©\nå‡ºå‘æ—¶é—´ï¼š${time}\næ—…è¡Œäººæ ¼ï¼š${persona.name}\n\nè¯·æ¨è5ä¸ªæœ€é€‚åˆæˆ‘çš„æ—…è¡Œæ–¹æ¡ˆã€‚`;

  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'glm-4-flash',max_tokens:4500,messages:[{role:'system',content:systemPrompt},{role:'user',content:userMsg}]})});
    if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(`APIé”™è¯¯ ${res.status}: ${JSON.stringify(e)}`);}
    const data=await res.json();
    const raw=data.choices?.[0]?.message?.content||'{}';
    const clean=raw.replace(/```json|```/g,'').trim();
    let parsed;
    try{parsed=JSON.parse(clean);}catch(e){throw new Error('AIè¿”å›æ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡è¯•');}
    plans=parsed.plans||[];
    renderResults();
    if(plans.length>0){initMap();selectPlan(plans[0].id);}
  }catch(e){errEl.textContent='é”™è¯¯ï¼š'+e.message;}
  finally{btn.disabled=false;btnText.textContent='ä¸ºæˆ‘å®šåˆ¶è¡Œç¨‹';}
}

function renderResults(){
  const el=document.getElementById('results-list');
  if(!plans.length){el.innerHTML='<div class="state-box"><div class="state-icon">ğŸŒ¿</div><div class="state-title">æš‚æ— ç»“æœï¼Œè¯·é‡è¯•</div></div>';return;}
  el.innerHTML=plans.map((p,i)=>`
    <div class="result-card ${activeId===p.id?'active':''}" id="rc-${p.id}" onclick="selectPlan('${p.id}')">
      <div class="rc-num">æ–¹æ¡ˆ ${String(i+1).padStart(2,'0')}</div>
      <div class="rc-title">${p.title}</div>
      <div class="rc-loc">ğŸ“ ${p.location} Â· ${p.region}</div>
      <div class="rc-why">${p.whyYou||''}</div>
      <div class="rc-tags">
        <span class="tag tag-type">${p.type}</span>
        <span class="tag tag-season">${p.season}</span>
        <span class="tag tag-crowd">${p.crowd}</span>
        ${p.matchScore?`<span class="tag tag-match">åŒ¹é… ${p.matchScore}</span>`:''}
      </div>
      <div class="rc-footer">
        <div class="rc-days">${p.days} å¤©è¡Œç¨‹</div>
        <button class="save-btn ${isSaved(p.id)?'saved':''}" onclick="event.stopPropagation();toggleSave('${p.id}')">${isSaved(p.id)?'â˜…':'â˜†'}</button>
      </div>
    </div>`).join('');
}

function selectPlan(id){
  activeId=id;
  document.querySelectorAll('.result-card').forEach(el=>el.classList.remove('active'));
  const rc=document.getElementById('rc-'+id);if(rc)rc.classList.add('active');
  const plan=plans.find(p=>p.id===id);
  if(plan){
    showPlanOnMap(plan);
    showDetail(plan);
    // æ‰‹æœºä¸Šè‡ªåŠ¨æ»šåŠ¨åˆ°è¯¦æƒ…åŒºåŸŸ
    if(window.innerWidth<=768){
      setTimeout(()=>{
        document.getElementById('detail-panel').scrollIntoView({behavior:'smooth',block:'start'});
      },100);
    }
  }
}

function initMap(){
  if(map)return;
  map=L.map('map',{zoomControl:false}).setView([35,104],4);
  L.control.zoom({position:'topright'}).addTo(map);
  // é«˜å¾·ç“¦ç‰‡ï¼Œå›½å†…å¿«ï¼Œæ— éœ€Key
  L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',{
    subdomains:'1234', maxZoom:18, attribution:'Â© é«˜å¾·åœ°å›¾'
  }).addTo(map);
  document.getElementById('map-hint').style.display='none';
}

function showPlanOnMap(plan){
  markers.forEach(m=>map.removeLayer(m));markers=[];
  if(routeLine){map.removeLayer(routeLine);routeLine=null;}
  const wps=plan.waypoints||[];
  const pts=wps.length>0?wps:[{lat:plan.lat,lng:plan.lng,name:plan.location,note:''}];
  const latlngs=[];
  pts.forEach((wp,i)=>{
    if(!wp.lat||!wp.lng)return;
    latlngs.push([wp.lat,wp.lng]);
    const icon=L.divIcon({className:'',html:`<div style="width:26px;height:26px;border-radius:50%;background:#0d0f0e;border:2px solid #6db882;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:10px;color:#6db882;font-weight:700;box-shadow:0 0 12px rgba(109,184,130,0.35)">${i+1}</div>`,iconSize:[26,26],iconAnchor:[13,13]});
    const m=L.marker([wp.lat,wp.lng],{icon})
      .bindPopup(`<div style="font-family:'Noto Sans SC',sans-serif;font-size:13px;padding:8px 12px;min-width:120px"><strong style="color:#2d6a4f">${wp.name}</strong>${wp.note?`<br><span style="font-size:11px;color:#666">${wp.note}</span>`:''}</div>`)
      .addTo(map);
    markers.push(m);
  });
  if(latlngs.length>1){
    routeLine=L.polyline(latlngs,{color:'#4a8c5c',weight:2,opacity:0.7,dashArray:'6,8'}).addTo(map);
    map.fitBounds(L.latLngBounds(latlngs),{padding:[40,40]});
  } else if(latlngs.length===1){
    map.setView(latlngs[0],9);
  }
}

function showDetail(plan){
  document.getElementById('detail-empty').style.display='none';
  const el=document.getElementById('detail-inner');
  el.style.display='block';
  const saved=isSaved(plan.id);
  const itHTML=(plan.itinerary||[]).map(d=>`
    <div class="day-block">
      <div class="day-header"><div class="day-num">Day ${d.day}</div><div class="day-title-text">${d.title}</div></div>
      <div class="time-slots">
        <div class="time-slot"><div class="time-label">ä¸Šåˆ</div><div class="time-content">${d.morning||''}</div></div>
        <div class="time-slot"><div class="time-label">ä¸‹åˆ</div><div class="time-content">${d.afternoon||''}</div></div>
        <div class="time-slot"><div class="time-label">å‚æ™š</div><div class="time-content">${d.evening||''}</div></div>
      </div>
    </div>`).join('');
  const tr=plan.transport||{},st=plan.stay||{},food=plan.food||[];
  el.innerHTML=`
    <div class="detail-header">
      <div>
        <div class="detail-title">${plan.title}</div>
        <div class="detail-loc">ğŸ“ ${plan.location} Â· ${plan.region}</div>
        ${plan.whyYou?`<div class="detail-why">âœ¦ ${plan.whyYou}</div>`:''}
      </div>
      <button class="detail-save-btn ${saved?'saved':''}" onclick="toggleSave('${plan.id}')">${saved?'â˜… å·²æ”¶è—':'â˜† æ”¶ è—'}</button>
    </div>
    <div class="detail-tags">
      <span class="tag tag-type">${plan.type}</span>
      <span class="tag tag-season">${plan.season}</span>
      <span class="tag tag-crowd">${plan.crowd}</span>
      ${plan.matchScore?`<span class="tag tag-match">åŒ¹é…åº¦ ${plan.matchScore}</span>`:''}
    </div>
    <div class="section"><div class="section-label">æ¯æ—¥è¡Œç¨‹</div>${itHTML}</div>
    <div class="section">
      <div class="section-label">äº¤é€šæ–¹æ¡ˆ</div>
      <div class="transport-grid">
        <div class="transport-item"><div class="transport-type">æŠµè¾¾æ–¹å¼</div><div class="transport-desc">${tr.arrival||'â€”'}</div></div>
        <div class="transport-item"><div class="transport-type">å½“åœ°ç§»åŠ¨</div><div class="transport-desc">${tr.local||'â€”'}</div></div>
      </div>
    </div>
    <div class="section">
      <div class="section-label">ä½å®¿å»ºè®®</div>
      <div class="stay-box">
        <div class="stay-type">${st.type||'â€”'}</div>
        <div class="stay-price">${st.price||''}</div>
        <div class="stay-reason">${st.reason||''}</div>
      </div>
    </div>
    ${food.length?`<div class="section"><div class="section-label">å½“åœ°ç‰¹è‰²é£Ÿç‰©</div><div class="food-list">${food.map(f=>`<div class="food-item">ğŸœ ${f}</div>`).join('')}</div></div>`:''}
  `;
}

function isSaved(id){return savedPlans.some(p=>p.id===id);}

function toggleSave(id){
  const plan=plans.find(p=>p.id===id)||savedPlans.find(p=>p.id===id);
  if(!plan)return;
  if(isSaved(id)){savedPlans=savedPlans.filter(p=>p.id!==id);}
  else{savedPlans.push(plan);}
  localStorage.setItem('sj_saved',JSON.stringify(savedPlans));
  updateBadge();renderResults();
  if(activeId===id)showDetail(plan);
  if(document.getElementById('page-saved').classList.contains('visible'))renderSaved();
}

function updateBadge(){
  const b=document.getElementById('saved-badge');
  b.textContent=savedPlans.length;
  b.classList.toggle('show',savedPlans.length>0);
}

function showPage(page){
  document.getElementById('page-explore').style.display=page==='explore'?'':'none';
  document.getElementById('page-saved').classList.toggle('visible',page==='saved');
  document.getElementById('btn-explore').classList.toggle('active',page==='explore');
  document.getElementById('btn-saved').classList.toggle('active',page==='saved');
  if(page==='saved')renderSaved();
}

function renderSaved(){
  const el=document.getElementById('saved-content');
  if(!savedPlans.length){el.innerHTML=`<div class="saved-empty"><div style="font-size:36px;opacity:0.2;margin-bottom:12px">â˜†</div><div style="font-family:'Noto Serif SC',serif;font-size:18px;font-style:italic;color:#5a6058">æš‚æ— æ”¶è—</div><div style="font-size:12px;color:#3a4038;margin-top:6px">åœ¨æ¢ç´¢é¡µé¢æ”¶è—å¿ƒä»ªçš„æ—…ç¨‹</div></div>`;return;}
  el.innerHTML=`<div class="saved-grid">${savedPlans.map(p=>`<div class="saved-card"><div class="sc-title">${p.title}</div><div class="sc-loc">ğŸ“ ${p.location} Â· ${p.region}</div><div class="sc-why">${p.whyYou||''}</div><div class="sc-footer"><div class="sc-days">${p.days}å¤© Â· ${p.type}</div><button class="sc-remove" onclick="removeSaved('${p.id}')">ç§»é™¤</button></div></div>`).join('')}</div>`;
}

function removeSaved(id){
  savedPlans=savedPlans.filter(p=>p.id!==id);
  localStorage.setItem('sj_saved',JSON.stringify(savedPlans));
  updateBadge();renderSaved();
}

updateBadge();
showQuiz();
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.activeElement.id==='inp-region')doSearch();});
</script>
</body>
</html>
